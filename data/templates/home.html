<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Báo cáo trực quan doanh số</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  canvas {
    max-width: 100%;
    width: 100%;
    height: auto !important;
  }
  .chart-container {
    width: 100%;
    max-width: 1000px;
    margin: auto;
    padding: 10px 0;
  }
  .insight-box {
    background: #fff3cd;
    border-left: 6px solid #ffeeba;
    padding: 15px;
    margin: 20px auto;
    max-width: 1000px;
    font-size: 14px;
    line-height: 1.6;
  }
  <style>
    body { font-family: Arial; padding: 20px; }
    h1 { text-align: center; }
    .menu { margin-bottom: 20px; text-align: center; }
    .menu button { margin: 5px; padding: 10px 20px; cursor: pointer; }
    .dashboard { display: none; }
    .active { display: block; }
    .kpi-row {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 20px;
      margin: 20px 0;
    }
    .kpi-card {
      border: 2px solid #1565c0;
      border-radius: 10px;
      padding: 20px 30px;
      text-align: center;
      min-width: 150px;
      background: #f5faff;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .kpi-card h2 {
      color: #1565c0;
      margin: 0;
      font-size: 28px;
    }
    .kpi-card p {
      margin: 8px 0 0;
      color: #555;
      font-size: 14px;
    }
    .chart-insight-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 30px;
      max-width: 1400px;  /* Tăng từ 1200 lên 1400 */
      margin: 40px auto;
      align-items: stretch;
    }

    .chart-box, .insight-box {
      flex: 1 1 600px;  /* Tăng chiều rộng mỗi box */
      background: #fff;
      border: 1.5px solid #bfcfff;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      box-sizing: border-box;
      min-height: 420px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .chart-box canvas {
      width: 100% !important;
      height: auto !important;
    }

    .insight-box h3 {
      margin-top: 0;
      font-size: 20px;
      color: #2c3e50;
    }

    .insight-box p {
      font-size: 15.5px;
      line-height: 1.8;
      color: #444;
      margin: 0;
    }

    
  </style>
</head>
<body>

  <h1>BÁO CÁO TRỰC QUAN HÓA DỮ LIỆU</h1>

  <div class="menu">
    <button onclick="showDashboard('overview')">Hiệu suất tổng thể</button>
    <button onclick="showDashboard('region')">Khu vực địa lý</button>
    <button onclick="showDashboard('segment')">Phân khúc khách hàng & Hành vi vận chuyển</button>
    <button onclick="showDashboard('category')">Danh mục sản phẩm</button>
  </div>

  <!-- VÙNG 1: Doanh thu theo vùng -->
  <div id="region" class="dashboard">
    <h2 style="margin-top: 40px;">Lượng đơn hàng phân bổ theo quốc gia</h2>
    <div id="countryOrderMap" style="height: 500px;"></div> 

    <h2>Doanh thu theo từng vùng</h2>
    <div class="chart-insight-row">
      <div class="chart-box">
        <canvas id="salesByRegionChart"></canvas>
      </div>
      <div class="insight-box">
        <h3>Phân tích dữ liệu</h3>
        <p><strong></strong> Về mặt phân bổ doanh thu theo khu vực, Central đang là vùng dẫn đầu với doanh thu hơn 710.000 USD, chiếm phần lớn thị phần toàn hệ thống. Tiếp theo là các khu vực như South (~420K) và North (~300K). Các vùng như Canada (~20K), Caribbean (~150K) và West (~170K) nằm trong nhóm có doanh thu thấp nhất. Dữ liệu cho thấy có sự phân hóa mạnh mẽ giữa các vùng, đặc biệt là Central đang đóng vai trò như một thị trường trụ cột, trong khi Canada gần như không đóng góp đáng kể.</p>
      </div>
    </div>

    <h2 style="margin-top: 40px;">Top 3 khu vực có doanh thu cao nhất</h2>
    <div class="chart-insight-row">
      <div class="chart-box">
        <canvas id="top3HighRegionChart"></canvas>
      </div>
      <div class="insight-box">
        <h3>Phân tích dữ liệu</h3>
        <p><strong></strong> Central – North – South tăng trưởng rõ rệt qua từng năm và duy trì vị trí dẫn đầu.</p>
      </div>
    </div>

    <h2 style="margin-top: 40px;">Top 3 khu vực có doanh thu thấp nhất</h2>
    <div class="chart-insight-row">
      <div class="chart-box">
        <canvas id="top3LowRegionChart"></canvas>
      </div>
      <div class="insight-box">
        <h3>Phân tích dữ liệu</h3>
        <p><strong></strong> Canada – Caribbean – West duy trì doanh thu thấp và tăng trưởng khiêm tốn. Cụ thể, năm 2014, doanh thu khu vực West là cao nhất trong nhóm thấp với 69.000 USD, trong khi Canada chỉ đạt 4.000 USD, gần như không có cải thiện đáng kể so với các năm trước.</p>
      </div>
    </div>

    <h2 style="margin-top: 40px;">Tốc độ tăng trưởng doanh thu (Top 3 vs Bottom 3)</h2>
    <div class="chart-insight-row">
      <div class="chart-box">
        <canvas id="revenueGrowthChart"></canvas>
      </div>
      <div class="insight-box">
        <h3>Phân tích dữ liệu</h3>
        <p><strong></strong> Top 3 khu vực (Central, South, North) có đà tăng trưởng tốt từ 0.27M USD (2011) lên tới 0.47M USD (2014), trong khi nhóm Bottom 3 (Canada, Caribbean, West) tăng rất chậm, chỉ từ 0.05M lên 0.08M USD. Điều này phản ánh rằng các khu vực yếu không có nhiều cải thiện, cho thấy hạn chế trong chiến lược địa phương hóa hoặc marketing vùng.</p>
      </div>
    </div>

    <h2 style="margin-top: 40px;">Các ngành hàng tại top 3 khu vực có doanh thu cao nhất</h2>
    <div class="chart-insight-row">
      <div class="chart-box">
        <canvas id="categoryByTopRegionsChart"></canvas>
      </div>
      <div class="insight-box">
        <h3>Phân tích dữ liệu</h3>
        <p><strong></strong> Nhóm ngành hàng chủ lực tại Central là Binders (1.4K), Art (1.3K), Storage (1.2K). Tại North và South, cũng là những nhóm ngành tương tự nhưng với quy mô nhỏ hơn. Điểm đáng lưu ý là các sản phẩm như Chairs, Phones, Accessories đều xuất hiện đồng đều ở cả 3 khu vực lớn, thể hiện mức độ phổ biến và ổn định cao – có thể được xem là sản phẩm chiến lược để mở rộng ra các vùng thị trường mới.</p>
      </div>
    </div>

    <h2 style="margin-top: 40px;">Top 10 quốc gia có lợi nhuận cao nhất</h2>
    <div class="chart-insight-row">
      <div class="chart-box">
        <canvas id="topProfitCountriesChart"></canvas>
      </div>
      <div class="insight-box">
        <h3>Phân tích dữ liệu</h3>
        <p><strong></strong> Phân tích theo quốc gia cho thấy Mỹ là thị trường mang lại lợi nhuận cao nhất với con số ấn tượng là 85.000 USD, chiếm phần đáng kể trong tổng lợi nhuận. Theo sau là Trung Quốc (44K), Úc (34K), Pháp và Ấn Độ (cùng đạt 32K). Các quốc gia phát triển tại châu Âu như Anh (26K), Đức (25K), và Mexico (23K) cũng đóng góp tích cực. Nhóm này phản ánh các thị trường chủ lực đang được đầu tư đúng hướng và cần tiếp tục duy trì.</p>
      </div>
    </div>

    <h2 style="margin-top: 40px;">Top 10 quốc gia có lợi nhuận thấp nhất</h2>
    <div class="chart-insight-row">
      <div class="chart-box">
        <canvas id="bottomProfitCountriesChart"></canvas>
      </div>
      <div class="insight-box">
        <h3>Phân tích dữ liệu</h3>
        <p><strong></strong> Một số quốc gia đang gây lỗ nghiêm trọng, tiêu biểu như Nigeria với mức lỗ lên tới -23.000 USD, Honduras (-10K), Hà Lan và Argentina (-8K và -5K). Các nước châu Á như Thái Lan, Hàn Quốc, Philippines cũng lỗ nhẹ từ -3K đến -4K. Đây là cảnh báo rõ ràng về việc phân bổ nguồn lực không hiệu quả tại những thị trường kém sinh lời – có thể do chi phí vận hành cao, thị trường không phù hợp, hoặc chính sách giá bán/chiết khấu chưa tối ưu.</p>
      </div>
    </div>
  </div>

  <!-- VÙNG 2: Phân khúc và Phương thức vận chuyển -->
  <div id="segment" class="dashboard">
    <h2>Doanh thu các phân khúc</h2>
    <div class="chart-insight-row">
      <div class="chart-box">
        <canvas id="segmentRevenueChart"></canvas>
      </div>
      <div class="insight-box">
        <h3>Phân tích dữ liệu</h3>
        <p><strong></strong> Về mặt doanh thu, Consumer là phân khúc dẫn đầu với gần 1tr7 USD, chiếm 51.04% tổng doanh thu, tiếp theo là Corporate (30.87%) và Home Office (18.09%).</p>
      </div>
    </div>

    <h2>Lợi nhuận theo phân khúc và ngành hàng</h2>
    <div class="chart-insight-row">
      <div class="chart-box">
        <canvas id="segmentCategoryProfitChart"></canvas>
      </div>
      <div class="insight-box">
        <h3>Phân tích dữ liệu</h3>
        <p><strong></strong>Xét theo lợi nhuận từng nhóm hàng và phân khúc, Technology là nhóm ngành có lợi nhuận cao nhất trong cả ba phân khúc, đặc biệt nổi bật ở Consumer với 96K USD, theo sau là Office Supplies và Furniture. Ngành hàng Furniture nhìn chung đem lại lợi nhuận thấp hơn đáng kể ở mọi phân khúc, đặc biệt là với phân khúc Home Office (chỉ 17K USD). Điều này đặt ra câu hỏi về hiệu quả kinh doanh nhóm hàng này và khả năng tái cơ cấu danh mục.</p>
      </div>
    </div>

    <h2>Doanh thu theo phân khúc khách hàng qua các năm</h2>
    <div class="chart-insight-row">
      <div class="chart-box">
        <canvas id="segmentSalesOverTimeChart"></canvas>
      </div>
      <div class="insight-box">
        <h3>Phân tích dữ liệu</h3>
        <p><strong>Insight:</strong> Biểu đồ theo năm cho thấy cả ba phân khúc đều có xu hướng tăng trưởng ổn định về doanh thu, trong đó giai đoạn 2012–2013 là giai đoạn tăng mạnh nhất, đặc biệt với nhóm Home Office. Điều này cho thấy sự phát triển đều của toàn bộ hệ thống khách hàng và hiệu quả của các chiến lược marketing hoặc chiết khấu giai đoạn này.</p>
      </div>
    </div>

    <h2>Lợi nhuận theo phân khúc khách hàng qua các năm</h2>
    <div class="chart-insight-row">
      <div class="chart-box">
        <canvas id="segmentProfitOverTimeChart"></canvas>
      </div>
      <div class="insight-box">
        <h3>Phân tích dữ liệu</h3>
        <p><strong></strong> Biểu đồ theo năm cho thấy cả ba phân khúc đều có xu hướng tăng trưởng ổn định về lợi nhuận, trong đó giai đoạn 2012–2013 là giai đoạn tăng mạnh nhất, đặc biệt với nhóm Home Office. Điều này cho thấy sự phát triển đều của toàn bộ hệ thống khách hàng và hiệu quả của các chiến lược marketing hoặc chiết khấu giai đoạn này.</p>
      </div>
    </div>

    <h2>Doanh thu theo phương thức vận chuyển</h2>
    <div class="chart-insight-row">
      <div class="chart-box">
        <canvas id="shippingSalesChart"></canvas>
      </div>
      <div class="insight-box">
        <h3>Phân tích dữ liệu</h3>
        <p><strong></strong> Phân tích theo phương thức giao hàng cho thấy Standard Class vẫn là hình thức chủ đạo với doanh thu vượt trội so với các hình thức còn lại và chiếm thị phần lớn nhất.</p>
      </div>
    </div>

    <h2 style="margin-top: 40px;">Lợi nhuận theo phương thức vận chuyển</h2>
    <div class="chart-insight-row">
      <div class="chart-box">
        <canvas id="shippingProfitChart"></canvas>
      </div>
      <div class="insight-box">
        <h3>Phân tích dữ liệu</h3>
        <p><strong></strong> Phân tích theo phương thức giao hàng cho thấy Standard Class vẫn là hình thức chủ đạo với lợi nhuận vượt trội so với các hình thức còn lại. Không những chiếm thị phần lớn nhất, Standard Class còn thể hiện khả năng tạo lợi nhuận bền vững qua từng năm. Trong khi đó, Same Day và First Class dù có sự tăng nhẹ nhưng vẫn chiếm tỷ trọng thấp và chưa tạo ra hiệu suất lợi nhuận đáng kể, phản ánh nhu cầu giao nhanh chưa phải là ưu tiên của phần lớn khách hàng hiện tại</p>
      </div>
    </div>
  </div>

  <!-- VÙNG 3: Ngành hàng top -->
  <div id="category" class="dashboard">
    <h2 style="margin-top: 40px;">Doanh thu & Lợi nhuận theo ngành hàng</h2>
    <div class="chart-insight-row">
      <div class="chart-box">
        <canvas id="categorySalesProfitChart"></canvas>
      </div>
      <div class="insight-box">
        <h3>Phân tích dữ liệu</h3>
        <p><strong></strong> Biểu đồ nhấn mạnh sự mất cân đối giữa quy mô bán hàng và hiệu quả tài chính. Một số ngành như Appliances và Storage có doanh thu đáng kể nhưng lợi nhuận lại không nổi bật. Ngược lại, Copiers không chỉ bán chạy mà còn mang lại lợi nhuận cao (~78K USD), chứng minh đây là sản phẩm chủ lực vừa bán tốt vừa có tỷ suất sinh lời cao.</p>
      </div>
    </div>

    <h2 style="margin-top: 40px;">Hiệu suất ngành hàng</h2>
    <div class="chart-insight-row">
      <div class="chart-box">
        <canvas id="productPerformanceChart"></canvas>
      </div>
      <div class="insight-box">
        <h3>Phân tích dữ liệu</h3>
        <p><strong></strong>Nhìn chung, các điểm có chiết khấu càng cao thì biên lợi nhuận càng thấp, thậm chí âm – như Tables là ví dụ rõ ràng. Ngược lại, những điểm gần trục trái với biên lợi nhuận cao và chiết khấu thấp như Paper, Labels, Copiers – là những điểm ngọt cần được tập trung đầu tư nhiều hơn</p>
      </div>
    </div>

     <h2 style="margin-top: 40px;">Lợi nhuận theo từng danh mục</h2>
    <div class="chart-insight-row">
      <div class="chart-box">
        <canvas id="profitByCategoryChart"></canvas>
      </div>
      <div class="insight-box">
        <h3>Phân tích dữ liệu</h3>
        <p><strong></strong> Về mặt danh mục sản phẩm, Technology đang là nhóm mang lại lợi nhuận cao nhất với 185.000 USD, theo sau là Office Supplies (135K) và cuối cùng là Furniture (81K).</p>
      </div>
    </div>

    <h2 style="margin-top: 40px;">Chiết khấu trung bình theo từng danh mục</h2>
    <div class="chart-insight-row">
      <div class="chart-box">
        <canvas id="avgDiscountByCategoryChart"></canvas>
      </div>
      <div class="insight-box">
        <h3>Phân tích dữ liệu</h3>
        <p><strong></strong> Biểu đồ chiết khấu trung bình lại cho thấy Furniture là nhóm có mức chiết khấu cao nhất (16.54%), trong khi Technology và Office Supplies chỉ ở mức ~13.8–13.9%. Điều này phần nào lý giải tại sao Furniture có lợi nhuận thấp dù doanh thu không hề thấp – mức chiết khấu cao đang ăn mòn biên lợi nhuận.</p>
      </div>
    </div>

    <h2>Lợi nhuận theo ngành hàng qua các năm</h2>
    <div class="chart-insight-row">
      <div class="chart-box">
        <canvas id="profitBySubCategoryOverTimeChart"></canvas>
      </div>
      <div class="insight-box">
        <h3>Phân tích dữ liệu</h3>
        <p><strong></strong> Dữ liệu cho thấy trong giai đoạn 2011–2014, mặt hàng Phones đạt lợi nhuận cao nhất và duy trì mức tăng trưởng ổn định qua các năm. Copiers cũng ghi nhận lợi nhuận cao với mức tăng đáng kể, phản ánh nhu cầu mạnh từ thị trường. Chairs và Accessories có lợi nhuận tích cực, tuy không cao bằng Phones hay Copiers; trong đó, Accessories có phần biến động hơn. Mặt hàng Storage giữ mức lợi nhuận ổn định nhưng không có sự tăng trưởng rõ rệt. Ngược lại, các mặt hàng như Labels và Fasteners lại ghi nhận lợi nhuận âm, cho thấy cần có sự điều chỉnh trong chiến lược kinh doanh.</p>
      </div>
    </div>
  </div>


  <!-- VÙNG 4: Overview -->
  <div id="overview" class="dashboard active">
    <!-- KPIs dãy 1 -->
    <div class="kpi-row">
      <div class="kpi-card"><h2 id="kpiSales">--</h2><p>Sum of sales</p></div>
      <div class="kpi-card"><h2 id="kpiProfit">--</h2><p>Sum of profit</p></div>
      <div class="kpi-card"><h2 id="kpiQty">--</h2><p>Sum of quantity</p></div>
      <div class="kpi-card"><h2 id="kpiDiscount">--</h2><p>Average of discount</p></div>
    </div>

    <!-- KPIs dãy 2 -->
    <div class="kpi-row">
      <div class="kpi-card"><h2 id="kpiAvgSales">--</h2><p>Average of sales</p></div>
      <div class="kpi-card"><h2 id="kpiAvgProfit">--</h2><p>Average of profit</p></div>
      <div class="kpi-card"><h2 id="kpiMargin">--</h2><p>Profit Margin</p></div>
    </div>

    <h2 style="margin-top: 20px;">Doanh thu và lợi nhuận theo năm</h2>
    <div class="chart-insight-row">
      <!-- Biểu đồ bên trái -->
      <div class="chart-box">
        <canvas id="yearlySalesProfitChart"></canvas>
      </div>

      <!-- Phân tích bên phải -->
      <div class="insight-box">
        <h3>Phân tích dữ liệu</h3>
        <p><strong></strong> Doanh thu có xu hướng tăng trưởng liên tục qua các năm, từ 0.6 triệu USD (2011) lên đến 1.05 triệu USD (2014). Tuy nhiên, lợi nhuận tăng rất chậm, chỉ từ 0.08 triệu lên 0.12 triệu USD – điều này phản ánh rõ vấn đề về hiệu suất lợi nhuận: doanh số tăng nhưng lợi nhuận không theo kịp.</p>
      </div>
    </div>
    
    <h2>Doanh thu theo khu vực</h2>
    <div class="chart-insight-row">
      <div class="chart-box">
        <canvas id="salesByRegionInOverviewChart"></canvas>
      </div>
      <div class="insight-box">
        <h3>Phân tích dữ liệu</h3>
        <p><strong></strong> Khu vực Central đang là thị trường trọng điểm với hơn 41% tổng doanh thu, vượt xa các khu vực còn lại</p>
      </div>
    </div>

    <h2 style="margin-top: 40px;">Doanh thu & Lợi nhuận theo phân khúc</h2>
    <div class="chart-insight-row">
      <div class="chart-box">
        <canvas id="profitBySegmentChart"></canvas>
      </div>
      <div class="insight-box">
        <h3>Phân tích dữ liệu</h3>
        <p><strong></strong> Nhóm Consumer là nhóm mang lại lợi nhuận cao nhất (khoảng 200.000 USD), chiếm tỷ trọng lớn trong cơ cấu khách hàng và đang tăng trưởng tốt – điều này cho thấy đây là phân khúc chủ lực cần được tập trung chăm sóc, mở rộng và khai thác sâu hơn. Trong khi đó, nhóm Corporate và đặc biệt là Home Office mang lại hiệu quả kém hơn đáng kể.</p>
      </div>
    </div>

    <h2>Doanh thu & Lợi nhuận theo nhóm hàng</h2>
    <div class="chart-insight-row">
      <div class="chart-box">
        <canvas id="categoryGroupChart"></canvas>
      </div>
      <div class="insight-box">
        <h3>Phân tích dữ liệu</h3>
        <p><strong></strong> Technology là ngành có doanh thu cao nhất (~1.2 triệu USD) và đồng thời cũng mang lại lợi nhuận tốt nhất (~200.000 USD). Trong khi, Furniture và Office Supplies cũng có doanh thu cao (~1 triệu USD mỗi ngành) nhưng lại mang lại lợi nhuận khiêm tốn (~100.000 USD), cho thấy dấu hiệu kém hiệu quả về mặt chi phí hoặc bị ảnh hưởng bởi mức chiết khấu cao.</p>
      </div>
    </div>

    <h2 style="margin-top: 40px;">Phương thức giao hàng</h2>
    <div class="chart-insight-row">
      <div class="chart-box">
        <canvas id="shipModeChart"></canvas>
      </div>
      <div class="insight-box">
        <h3>Phân tích dữ liệu</h3>
        <p><strong></strong> Phần lớn khách hàng lựa chọn phương thức vận chuyển tiết kiệm – Standard Class chiếm tới 52.7% tổng số đơn hàng. Các phương thức giao nhanh như First Class hay Same Day chỉ chiếm tỷ trọng nhỏ và không đóng góp nổi bật về mặt lợi nhuận. Điều này cho thấy khách hàng hiện tại ưu tiên chi phí hơn tốc độ, và doanh nghiệp không cần đầu tư mạnh vào logistics cao cấp nếu không có lợi thế rõ ràng về biên lợi nhuận.</p>
      </div>
    </div>

  </div>
  

  <script>
    function showDashboard(id) {
      const dashboards = document.querySelectorAll('.dashboard');
      dashboards.forEach(div => div.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    // Biểu đồ 1: Doanh thu theo vùng
    fetch('/sales-by-region/')
      .then(res => res.json())
      .then(data => {
        new Chart(document.getElementById('salesByRegionChart'), {
          type: 'bar',
          data: {
            labels: data.regions,
            datasets: [{
              label: 'Sales',
              data: data.sales,
              backgroundColor: 'rgba(54, 162, 235, 0.7)'
            }]
          },
          options: { responsive: true }
        });
      });

    // Bạn có thể thêm fetch cho biểu đồ khác tương tự
    // Biểu đồ 2: Product Performance (bubble)
    fetch('/product-performance/')
    .then(res => res.json())
    .then(data => {
    const ctx = document.getElementById('productPerformanceChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'bubble',
        data: {
        datasets: data.sub_categories.map((label, i) => ({
            label: label,
            data: [{
            x: data.discounts[i] * 100,
            y: data.margins[i],
            r: Math.sqrt(data.sales[i]) / 100
            }],
            backgroundColor: `hsl(${i * 30}, 70%, 60%)`
        }))
        },
        options: {
        responsive: true,
        scales: {
            x: {
            title: { display: true, text: 'Tỷ lệ giảm giá (%)' }
            },
            y: {
            title: { display: true, text: 'Profit Margin (%)' }
            }
        },
        plugins: {
            tooltip: {
            callbacks: {
                label: function(ctx) {
                const s = data.sales[ctx.dataIndex].toFixed(0);
                return `${ctx.dataset.label}: Sales = ${s}`;
                }
            }
            }
        }
        }
    });
    });

    fetch('/category-sales-profit/')
    .then(res => res.json())
    .then(data => {
        new Chart(document.getElementById('categorySalesProfitChart'), {
        type: 'bar',
        data: {
            labels: data.sub_categories,
            datasets: [
            {
                label: 'Doanh thu',
                data: data.sales,
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
            },
            {
                label: 'Lợi nhuận',
                data: data.profits,
                backgroundColor: 'rgba(0, 0, 255, 0.8)',
            }
            ]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            scales: {
            x: { beginAtZero: true }
            }
        }
        });
    });

    // Biểu đồ 4: Doanh thu & Lợi nhuận theo nhóm hàng
    fetch('/sales-profit-by-category/')
    .then(res => res.json())
    .then(data => {
    new Chart(document.getElementById('categoryGroupChart'), {
        type: 'bar',
        data: {
        labels: data.categories,
        datasets: [
            {
            label: 'Doanh thu',
            data: data.sales,
            backgroundColor: 'rgba(0, 0, 139, 0.8)', // xanh đậm
            },
            {
            label: 'Lợi nhuận',
            data: data.profits,
            backgroundColor: 'rgba(30, 144, 255, 0.6)', // xanh nhạt
            }
        ]
        },
        options: {
        responsive: true,
        scales: {
            y: { beginAtZero: true }
        }
        }
    });
    });

    // Biểu đồ: Lợi nhuận theo ngành hàng theo năm
    fetch('/profit-over-time/')
    .then(res => res.json())
    .then(data => {
    new Chart(document.getElementById('profitBySubCategoryOverTimeChart'), {
        type: 'line',
        data: {
        labels: data.labels,
        datasets: data.datasets.map((d, i) => ({
            label: d.label,
            data: d.data,
            fill: false,
            borderColor: `hsl(${i * 30}, 70%, 50%)`,
            tension: 0.3
        }))
        },
        options: {
        responsive: true,
        scales: {
            y: {
            beginAtZero: false,
            title: {
                display: true,
                text: 'Lợi nhuận'
            }
            },
            x: {
            title: {
                display: true,
                text: 'Năm'
            }
            }
        }
        }
    });
    });


    let yearlyChart;

    function fetchYearlyData() {
      fetch('/yearly-sales-profit/')
        .then(response => response.json())
        .then(data => {
          if (yearlyChart) yearlyChart.destroy();

          yearlyChart = new Chart(document.getElementById('yearlySalesProfitChart'), {
            type: 'line',
            data: {
              labels: data.labels,  // danh sách năm
              datasets: [
                {
                  label: 'Doanh thu',
                  data: data.sales,
                  borderColor: 'blue',
                  backgroundColor: 'rgba(0,0,255,0.1)',
                  fill: true,
                  tension: 0.3
                },
                {
                  label: 'Lợi nhuận',
                  data: data.profits,
                  borderColor: 'green',
                  fill: false,
                  tension: 0.3
                }
              ]
            },
            options: {
              responsive: true,
              scales: {
                y: { beginAtZero: true },
                x: {
                  title: { display: true, text: 'Năm' }
                }
              }
            }
          });
        })
        .catch(error => console.error('Fetch error:', error));
    }

    // Gọi ngay sau khi DOM sẵn sàng
    document.addEventListener('DOMContentLoaded', fetchYearlyData);

    // Biểu đồ: Top 3 khu vực doanh thu cao nhất
    fetch('/top3-highest-sales-regions/')
    .then(res => res.json())
    .then(data => {
      new Chart(document.getElementById('top3HighRegionChart'), {
        type: 'bar',
        data: {
          labels: data.years,
          datasets: data.datasets.map((d, i) => ({
            label: d.label,
            data: d.data,
            backgroundColor: `hsl(${i * 60}, 70%, 60%)`
          }))
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true } }
        }
      });
    });

    // Biểu đồ: Top 3 khu vực doanh thu thấp nhất
    fetch('/top3-lowest-sales-regions/')
    .then(res => res.json())
    .then(data => {
      new Chart(document.getElementById('top3LowRegionChart'), {
        type: 'bar',
        data: {
          labels: data.years,
          datasets: data.datasets.map((d, i) => ({
            label: d.label,
            data: d.data,
            backgroundColor: `hsl(${i * 60 + 180}, 70%, 60%)`
          }))
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true } }
        }
      });
    });

    // Biểu đồ: Tăng trưởng doanh thu
    fetch('/revenue-growth/')
    .then(res => res.json())
    .then(data => {
      new Chart(document.getElementById('revenueGrowthChart'), {
        type: 'line',
        data: {
          labels: data.years,
          datasets: [
            {
              label: 'Top 3',
              data: data.top,
              borderColor: 'navy',
              tension: 0.4,
              fill: false
            },
            {
              label: 'Bottom 3',
              data: data.bottom,
              borderColor: 'dodgerblue',
              borderDash: [5, 5],
              tension: 0.4,
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    });

    // Biểu đồ: Ngành hàng theo top 3 vùng
    fetch('/category-by-top-regions/')
    .then(res => res.json())
    .then(data => {
      new Chart(document.getElementById('categoryByTopRegionsChart'), {
        type: 'bar',
        data: {
          labels: data.labels,
          datasets: data.datasets.map((d, i) => ({
            label: d.label,
            data: d.data,
            backgroundColor: `hsl(${i * 90}, 70%, 60%)`
          }))
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          plugins: {
            legend: { position: 'top' }
          },
          scales: {
            x: { stacked: true },
            y: { stacked: true }
          }
        }
      });
    });

    // Top 10 quốc gia lợi nhuận cao nhất
    fetch('/top10-profit-countries/')
    .then(res => res.json())
    .then(data => {
      new Chart(document.getElementById('topProfitCountriesChart'), {
        type: 'bar',
        data: {
          labels: data.labels,
          datasets: [{
            label: 'Profit',
            data: data.profits,
            backgroundColor: 'seagreen'
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          scales: {
            x: {
              beginAtZero: true
            }
          }
        }
      });
    });

    // Bottom 10 quốc gia lợi nhuận thấp nhất
    fetch('/bottom10-profit-countries/')
    .then(res => res.json())
    .then(data => {
      new Chart(document.getElementById('bottomProfitCountriesChart'), {
        type: 'bar',
        data: {
          labels: data.labels,
          datasets: [{
            label: 'Profit',
            data: data.profits,
            backgroundColor: 'indianred'
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          scales: {
            x: {
              beginAtZero: false  // để hiển thị cả số âm
            }
          }
        }
      });
    });

    // Biểu đồ: Chiết khấu trung bình theo danh mục
    fetch('/avg-discount-by-category/')
    .then(res => res.json())
    .then(data => {
      new Chart(document.getElementById('avgDiscountByCategoryChart'), {
        type: 'bar',
        data: {
          labels: data.categories,
          datasets: [{
            label: 'Chiết khấu (%)',
            data: data.avg_discounts,
            backgroundColor: ['#b39ddb', '#fdd835', '#ef9a9a']
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: value => value + '%'
              }
            }
          }
        }
      });
    });

    // Biểu đồ: Lợi nhuận theo danh mục
    fetch('/profit-by-category/')
    .then(res => res.json())
    .then(data => {
      new Chart(document.getElementById('profitByCategoryChart'), {
        type: 'bar',
        data: {
          labels: data.categories,
          datasets: [{
            label: 'Lợi nhuận',
            data: data.profits,
            backgroundColor: ['#fdd835', '#ef9a9a', '#b39ddb']
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    });

    // Biểu đồ: Doanh thu & Lợi nhuận theo phân khúc
    fetch('/profit-by-segment/')
    .then(res => res.json())
    .then(data => {
      new Chart(document.getElementById('profitBySegmentChart'), {
        type: 'bar',
        data: {
          labels: data.segments,
          datasets: [
            {
              label: 'Doanh thu',
              data: data.sales,
              backgroundColor: 'rgba(0, 123, 255, 0.7)'
            },
            {
              label: 'Lợi nhuận',
              data: data.profits,
              backgroundColor: 'rgba(40, 167, 69, 0.7)'
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    });

    // Biểu đồ: Doanh thu theo khu vực trong tab Tổng quan
    fetch('/sales-by-region/')
    .then(res => res.json())
    .then(data => {
      new Chart(document.getElementById('salesByRegionInOverviewChart'), {
        type: 'bar', 
        data: {
          labels: data.regions,
          datasets: [{
            label: 'Doanh thu',
            data: data.sales,
            backgroundColor: data.regions.map((_, i) => `hsl(${i * 30}, 70%, 60%)`)
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'right'
            }
          }
        }
      });
    });

    // Gọi dữ liệu KPI và hiển thị vào ô KPI
    fetch('/overview-kpis/')
    .then(res => res.json())
    .then(data => {
      document.getElementById('kpiSales').innerText = (data.sum_sales / 1_000_000).toFixed(1) + 'M';
      document.getElementById('kpiProfit').innerText = Math.round(data.sum_profit / 1000) + 'K';
      document.getElementById('kpiQty').innerText = Math.round(data.sum_qty / 1000) + 'K';
      document.getElementById('kpiDiscount').innerText = data.avg_discount + '%';

      document.getElementById('kpiAvgSales').innerText = '$' + data.avg_sales;
      document.getElementById('kpiAvgProfit').innerText = '$' + data.avg_profit;
      document.getElementById('kpiMargin').innerText = data.profit_margin + '%';
    });

    //Phương thức giao hàng
    fetch('/shipping-mode-distribution/')
    .then(res => res.json())
    .then(data => {
      new Chart(document.getElementById('shipModeChart'), {
        type: 'doughnut',
        data: {
          labels: data.ship_modes,
          datasets: [{
            label: 'Số lượng đơn hàng',
            data: data.counts,
            backgroundColor: ['#1e88e5', '#ff7043', '#ab47bc', '#43a047']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'right' }
          }
        }
      });
    });

    //Lượng đơn hàng phân bổ theo quốc gia
    fetch('/order-distribution-by-country/')
    .then(res => res.json())
    .then(data => {
      const map = L.map('countryOrderMap').setView([20, 0], 2); // center map

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      data.countries.forEach((country, i) => {
        const marker = L.circleMarker([data.lats[i], data.lons[i]], {
          radius: Math.sqrt(data.counts[i]) / 2,
          color: 'blue',
          fillColor: 'skyblue',
          fillOpacity: 0.6
        }).addTo(map);
        marker.bindPopup(`${country}: ${data.counts[i]} đơn hàng`);
      });
    });

    //Doanh thu & Lợi nhuận theo phân khúc khách hàng qua các năm
    fetch('/segment-trend-over-years/')
    .then(res => res.json())
    .then(result => {
      const years = result.years;
      const data = result.data;

      const colors = [
        { border: 'crimson', background: 'rgba(220, 20, 60, 0.2)' },
        { border: 'limegreen', background: 'rgba(50, 205, 50, 0.2)' },
        { border: 'deepskyblue', background: 'rgba(0, 191, 255, 0.2)' }
      ];

      const segments = Object.keys(data);

      const datasets = segments.map((segment, i) => ({
        label: segment,
        data: data[segment]?.sales || [],
        borderColor: colors[i % colors.length].border,
        backgroundColor: colors[i % colors.length].background,
        fill: true,
        tension: 0.4,
        pointRadius: 3
      }));

      new Chart(document.getElementById('segmentSalesOverTimeChart'), {
        type: 'line',
        data: {
          labels: years,
          datasets: datasets
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            title: {
              display: true,
              text: 'Doanh thu theo phân khúc khách hàng qua các năm'
            }
          },
          scales: {
            y: { beginAtZero: true },
            x: { title: { display: true, text: 'Năm' } }
          }
        }
      });
    });

    fetch('/segment-trend-over-years/')
    .then(res => res.json())
    .then(result => {
      const years = result.years;
      const data = result.data;

      const colors = [
        { border: 'crimson', background: 'rgba(220, 20, 60, 0.2)' },
        { border: 'limegreen', background: 'rgba(50, 205, 50, 0.2)' },
        { border: 'deepskyblue', background: 'rgba(0, 191, 255, 0.2)' }
      ];

      const segments = Object.keys(data);

      const datasets = segments.map((segment, i) => ({
        label: segment,
        data: data[segment]?.profit || [],
        borderColor: colors[i % colors.length].border,
        backgroundColor: colors[i % colors.length].background,
        fill: true,
        tension: 0.4,
        pointRadius: 3
      }));

      new Chart(document.getElementById('segmentProfitOverTimeChart'), {
        type: 'line',
        data: {
          labels: years,
          datasets: datasets
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            title: {
              display: true,
              text: 'Lợi nhuận theo phân khúc khách hàng qua các năm'
            }
          },
          scales: {
            y: { beginAtZero: true },
            x: { title: { display: true, text: 'Năm' } }
          }
        }
      });
    });

    //Doanh thu & Lợi nhuận theo phương thức vận chuyển 
    fetch('/shipping-mode-over-time/')
    .then(res => res.json())
    .then(result => {
      const years = result.years;
      const data = result.data;

      const colors = [
        { border: 'crimson', background: 'rgba(220, 20, 60, 0.2)' },
        { border: 'darkviolet', background: 'rgba(148, 0, 211, 0.2)' },
        { border: 'deepskyblue', background: 'rgba(0, 191, 255, 0.2)' },
        { border: 'darkorange', background: 'rgba(255, 140, 0, 0.2)' }
      ];

      const shipModes = Object.keys(data);

      // Doanh thu
      const salesDatasets = shipModes.map((mode, i) => ({
        label: mode,
        data: data[mode]?.sales || [],
        borderColor: colors[i % colors.length].border,
        backgroundColor: colors[i % colors.length].background,
        fill: true,
        tension: 0.4,
        pointRadius: 3
      }));

      new Chart(document.getElementById('shippingSalesChart'), {
        type: 'line',
        data: {
          labels: years,
          datasets: salesDatasets
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            title: {
              display: true,
              text: 'Doanh thu theo phương thức vận chuyển qua các năm'
            }
          },
          scales: {
            y: { beginAtZero: true },
            x: { title: { display: true, text: 'Năm' } }
          }
        }
      });

      // Lợi nhuận
      const profitDatasets = shipModes.map((mode, i) => ({
        label: mode,
        data: data[mode]?.profit || [],
        borderColor: colors[i % colors.length].border,
        backgroundColor: colors[i % colors.length].background,
        fill: true,
        tension: 0.4,
        pointRadius: 3
      }));

      new Chart(document.getElementById('shippingProfitChart'), {
        type: 'line',
        data: {
          labels: years,
          datasets: profitDatasets
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            title: {
              display: true,
              text: 'Lợi nhuận theo phương thức vận chuyển qua các năm'
            }
          },
          scales: {
            y: { beginAtZero: true },
            x: { title: { display: true, text: 'Năm' } }
          }
        }
      });
    });

    // Doanh thu các phân khúc 
    fetch('/segment-revenue-distribution/')
    .then(res => res.json())
    .then(data => {
      new Chart(document.getElementById('segmentRevenueChart'), {
        type: 'pie',
        data: {
          labels: data.labels,
          datasets: [{
            label: 'Doanh thu',
            data: data.values,
            backgroundColor: ['#1e88e5', '#ff7043', '#ab47bc']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'right' }
          }
        }
      });
    });

    // Lợi nhuận theo nhóm hàng trong các phân khúc 
    fetch('/segment-category-profit/')
    .then(res => res.json())
    .then(data => {
      new Chart(document.getElementById('segmentCategoryProfitChart'), {
        type: 'bar',
        data: {
          labels: data.segments,
          datasets: data.datasets.map((d, i) => ({
            label: d.label,
            data: d.data,
            backgroundColor: `hsl(${i * 100}, 70%, 60%)`
          }))
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    });




    // Bạn có thể thêm fetch cho biểu đồ khác tương tự

  </script>
</body>
</html>
